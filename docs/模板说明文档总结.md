# 模板说明文档总结

## 1. 目标与设计原则
- 将发票解析逻辑拆分为“规则配置（JSON 模板）+ 通用引擎（Java 代码）”。
- 新版式适配优先通过新增/修改模板完成，尽量不改业务代码。
- 模板通过 `identifiers` 自动匹配，实现多票据版式共存。

## 2. 模板通用结构
每个模板文件包含以下核心字段：
- `templateName`：模板名称（用于展示与日志定位）。
- `identifiers`：模板识别关键字列表；系统要求票据文本同时命中这些关键字才会匹配模板。
- `fields`：字段提取规则列表，每项规则包含：
  - `fieldName`：输出字段名。
  - `keywords`：关键字候选（按顺序尝试）。
  - `strategy`：提取策略（如 `SAME_LINE`/`BELOW`/`AREA`）。
  - `options`：策略参数（如 `trimChars`、`valuePattern`、坐标范围等）。
- `detailFields`（可选）：明细表提取配置，当前结构为：
  - `tableIdentifiers`：明细表表头识别关键字。
  - `columns`：列定义（`fieldName` + `header`）。

## 3. 提取策略与常见参数
- `SAME_LINE`：从关键字同行提取值。
  - 常用参数：`trimChars`、`valuePattern`。
- `BELOW`：从关键字下方行提取值。
  - 常用参数：`maxLinesBelow`、`stopAtKeywords`。
- `AREA`：按固定坐标区域提取值。
  - 常用参数：`x_start`、`y_start`、`width`、`height`。
- `REGEX`：通过正则模式直接提取目标值。
  - 常用参数：`valuePattern`、分组匹配相关参数（按模板配置）。
- `TABLE`：基于表头/列定位提取表格字段或明细信息。
  - 常用参数：列索引、表头关键字、行范围等（按模板配置）。

## 4. 当前系统已注册策略（启动日志）
- `AREA`
- `BELOW`
- `REGEX`
- `SAME_LINE`
- `TABLE`

## 5. 当前模板现状（resources/templates/invoice）
- `beijing-tongzhou-hospital-template.json`
  - 标识词：2 个。
  - 字段规则：5 项。
  - 策略覆盖：`SAME_LINE`、`BELOW`、`AREA`。
- `jilin-university-hospital-template.json`
  - 字段规则：26 项（主字段）+ 4 项（明细列定义）。
  - 主字段策略：以 `SAME_LINE` 为主。
  - 已配置 `detailFields`（支持明细表头与列映射）。

## 6. 维护与扩展建议
- 新增票据版式时，优先复制最相似模板再调整 `identifiers` 和 `fields`。
- `identifiers` 应选择稳定且区分度高的文本，避免模板误匹配。
- 仅在字段位置稳定时使用 `AREA`，否则优先关键字策略。
- 正则 `valuePattern` 建议用于金额、日期、编号等强格式字段，降低噪声。
- 模板更新后建议做回归验证：模板命中、关键字段完整性、金额/日期格式正确性。

## 7. 本次兼容性说明
- 已支持模板中的 `detailFields` 反序列化，并对未知字段启用忽略，降低模板结构演进导致的启动失败风险。
