# 版本迭代日志

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`src/main/java/com/kinghy/invoiceanalysis/strategy/impl/SameLineStrategy.java`
- 变更摘要：进一步修正 `SAME_LINE` 提取逻辑，改为基于关键字结束索引向后扫描同一行字符（不再依赖 `X >= roiXStart` 作为必要条件），解决字符间距/重叠场景下边界数字漏提取问题。

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`src/main/java/com/kinghy/invoiceanalysis/strategy/impl/SameLineStrategy.java`、`src/main/java/com/kinghy/invoiceanalysis/service/PositionalInvoiceExtractor.java`
- 变更摘要：修正同一行 ROI 字符收集逻辑，移除 `text.getX() > keywordPosition.getEndX()` 二次过滤，避免关键字右侧紧邻首字符（如“22060125”的第一个“2”）被误删；保留原有 `maxDistance` 距离约束。

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`docs/模板说明文档总结.md`
- 变更摘要：补充“当前系统已注册策略（AREA/BELOW/REGEX/SAME_LINE/TABLE）”，并扩展 `REGEX`、`TABLE` 策略说明。

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`src/main/java/com/kinghy/invoiceanalysis/service/InvoiceProcessor.java`
- 变更摘要：将首页文本提取改为基于 `TextPosition` 的视觉行重建（按 Y 分行、按 X 排序并按间距补空格），替换原 `PDFTextStripper` 纯文本输出，减少“票据代码与票据号码错行/错位”问题。

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`src/main/resources/templates/invoice/jilin-university-hospital-template.json`
- 变更摘要：结合吉林大学第一医院票据解析上下文，修正模板标识词，补充“医疗机构/医保类型”等关键字变体，并为编号、日期、金额、姓名与收款人等字段增加 `valuePattern` 约束，降低同一行串值风险。

## 2026-02-24
- 修改人/执行主体：AI Agent
- 影响文件：`src/main/resources/templates/invoice/jilin-university-hospital-template.json`
- 变更摘要：将模板 `fieldName` 对齐到 `PjcyDataNode`/`PjcyItemNode` 字段命名（如 `eInvoiceCode`、`eInvoiceNumber`、`payerPartyName`、`fundPayAmount`、`invoicingPartyName`、`handlingPerson`、`itemQuantity` 等），保留原有关键字与提取策略配置。
