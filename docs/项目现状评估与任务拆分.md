# 项目现状评估与可实现任务拆分

## 1. 现状总结（基于当前代码）
- `controller` 仅返回固定 `"success"`，尚未接入真实发票解析流程（`src/main/java/com/kinghy/invoiceanalysis/controller/InvoiceAnalysisController.java`）。
- `InvoiceProcessor` 核心流程已具备（模板匹配 + 策略执行），但缺少对外编排接口与异常分级返回。
- 模板系统支持 `filesystem/database` 双实现，但模板文件目前放在 `src/main/java/.../config/templates`，不利于标准资源管理与发布。
- 提取策略（SAME_LINE/BELOW/AREA/REGEX/TABLE）已实现，但复杂版面鲁棒性和参数校验覆盖仍不足。
- 测试仅有 `contextLoads`，缺少业务测试与回归用例。
- 当前环境无法执行 `mvn`（本机命令缺失），构建验证链路不完整。

## 2. 高优先级任务（P0，建议先做）

### Task P0-1：打通真实分析API
- 目标：提供可用的发票解析接口（上传 PDF，返回结构化字段）。
- 实现点：
  - 在 `/analysis/invoice` 接口接收 `MultipartFile`。
  - 调用 `InvoiceProcessor.process(InputStream, fileName)`。
  - 返回统一响应结构（`code/message/data`）。
- 验收标准：可通过 Postman 上传 PDF，返回模板匹配结果或明确失败原因。

### Task P0-2：统一异常与错误码
- 目标：避免仅日志报错，提升可观测性。
- 实现点：
  - 新增业务异常（模板未匹配、策略不存在、参数非法、PDF解析失败）。
  - 增加全局异常处理器 `@RestControllerAdvice`。
- 验收标准：API 对常见失败给出稳定错误码与中文提示。

### Task P0-3：补齐核心自动化测试
- 目标：覆盖关键链路，防止策略回归。
- 实现点：
  - `TemplateService` 匹配逻辑测试。
  - `StrategyFactory` 注册/获取测试。
  - 至少 3 个策略单测（`SAME_LINE/BELOW/REGEX`）。
- 验收标准：新增测试可独立运行，关键分支有断言。

## 3. 中优先级任务（P1）

### Task P1-1：模板资源与配置重构
- 目标：使模板部署更标准化。
- 实现点：
  - 将模板目录迁移至 `src/main/resources/templates/invoice` 或外置 `config/templates`。
  - 通过 `application-*.properties` 区分 dev/prod。
- 验收标准：切换配置无需改代码，可在不同环境稳定加载模板。

### Task P1-2：策略参数校验增强
- 目标：降低错误配置导致的隐性失败。
- 实现点：
  - 为 `BELOW/TABLE` 增加 `validateOptions`。
  - 对 `xAlignment/sortOrder/groupIndex` 等非法值显式拦截。
- 验收标准：非法模板在加载/执行时可被明确识别并定位字段。

### Task P1-3：移除或隔离演示代码
- 目标：减少生产代码噪音。
- 实现点：
  - 处理 `main` 演示方法（迁移到 `examples` 或测试）。
  - 清理未使用类或注释掉的服务标记。
- 验收标准：主干代码只保留可运行生产逻辑。

## 4. 低优先级任务（P2）

### Task P2-1：可观测性与运行治理
- 增加请求链路日志（traceId）、策略耗时统计、模板命中率指标。

### Task P2-2：接口与运维文档完善
- 补充 API 示例、模板字段规范、故障排查手册，确保新人可独立上手。

### Task P2-3：CI 基础流水线
- 配置最小 CI：编译、单测、静态检查（如 Checkstyle/SpotBugs，可分阶段接入）。

## 5. 建议执行顺序（两周节奏）
1. 第 1 周：P0-1、P0-2、P0-3。
2. 第 2 周：P1-1、P1-2、P1-3。
3. 持续迭代：P2 系列按运维反馈插入。
